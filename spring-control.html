<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spring Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-elevated: #111827;
      --bg-card: #0b1220;
      --accent-on: #22c55e;
      --accent-off: #6b7280;
      --accent-unknown: #fbbf24;
      --accent-primary: #06b6d4;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --border-subtle: #1f2937;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 48%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .brand-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .connection-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot.connected {
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .dot.disconnected {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.18);
    }

    .tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.85);
      border-radius: var(--radius-pill);
      padding: 4px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.55);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-radius: var(--radius-pill);
      cursor: pointer;
      user-select: none;
      transition: background 0.18s ease, color 0.18s ease, transform 0.1s ease;
    }

    .tab.active {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #0b1120;
      font-weight: 600;
      transform: translateY(-1px);
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: linear-gradient(145deg, #020617, #020617 45%, #0b1120);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.16);
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .pump-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 16px;
      align-items: center;
    }

    @media (max-width: 640px) {
      .pump-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .pump-visual {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .pump-ring {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 6px solid var(--accent-off);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: radial-gradient(circle at 30% 20%, #1e293b 0, #020617 55%, #020617 100%);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    .pump-ring::before {
      content: "";
      position: absolute;
      inset: 16px;
      border-radius: 50%;
      border: 1px dashed rgba(148, 163, 184, 0.45);
    }

    .pump-core {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #020617 60%);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.3);
      position: relative;
      overflow: hidden;
    }

    .pump-blade {
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      border: 3px solid rgba(248, 250, 252, 0.08);
      border-top-color: rgba(248, 250, 252, 0.8);
      border-right-color: rgba(56, 189, 248, 0.9);
      transform-origin: center;
      animation: spin 3.2s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .pump-state-label {
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .pill-large {
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
    }

    .pill-on {
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
      border-color: rgba(34, 197, 94, 0.35);
    }

    .pill-off {
      background: rgba(75, 85, 99, 0.24);
      color: #e5e7eb;
      border-color: rgba(75, 85, 99, 0.5);
    }

    .pill-unknown {
      background: rgba(251, 191, 36, 0.14);
      color: #fef9c3;
      border-color: rgba(251, 191, 36, 0.5);
      box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5);
      animation: pulse-ring 1.4s infinite;
    }

    @keyframes pulse-ring {
      0% {
        box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5);
      }
      70% {
        box-shadow: 0 0 0 8px rgba(251, 191, 36, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
      }
    }

    .pump-meta {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .pump-meta span {
      color: #e5e7eb;
    }

    .pump-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status-line {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot-small {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
    }

    .status-dot-pending {
      background: #facc15;
    }

    .status-dot-error {
      background: #ef4444;
    }

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 11px 16px;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #0b1120;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(56, 189, 248, 0.45);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.13s ease;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(56, 189, 248, 0.6);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 28px rgba(56, 189, 248, 0.4);
    }

    .primary-btn.disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn-spinner {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.25);
      border-top-color: #0f172a;
      animation: spin 0.8s linear infinite;
    }

    .error-banner {
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(239, 68, 68, 0.09);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.4);
    }

    .temp-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 640px) {
      .temp-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .temp-card {
      background: radial-gradient(circle at top left, #0f172a 0, #020617 50%);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .temp-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .temp-value-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .temp-value {
      font-size: 1.6rem;
      font-weight: 600;
    }

    .temp-unit {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .trend {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
    }

    .trend-up {
      color: #4ade80;
    }

    .trend-down {
      color: #f97373;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
      margin-top: 10px;
      color: var(--text-muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .legend-color {
      width: 12px;
      height: 4px;
      border-radius: 999px;
    }

    .chart-container {
      margin-top: 10px;
      background: radial-gradient(circle at top left, #020617 0, #020617 35%, #020617 100%);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 8px 10px 10px;
    }

    .chart-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .range-selector {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .range-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 3px 8px;
      font-size: 0.74rem;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .range-btn.active {
      background: rgba(56, 189, 248, 0.12);
      border-color: rgba(56, 189, 248, 0.9);
      color: #e0f2fe;
    }

    canvas {
      width: 100%;
      height: 180px;
      display: block;
    }

    @media (min-width: 768px) {
      canvas {
        height: 220px;
      }
    }

    .chart-overlay {
      position: relative;
    }

    .chart-overlay-message {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      background: radial-gradient(circle at center, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
      backdrop-filter: blur(2px);
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }

    .chart-overlay-message.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="top-bar">
      <div class="brand">
        <div class="brand-title">Spring Control</div>
        <div class="brand-subtitle">Site A water cooling system monitor</div>
      </div>
      <div class="connection-pill" id="connection-pill">
        <div class="dot disconnected" id="connection-dot"></div>
        <span id="connection-text">Disconnected from server</span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-screen="pump" id="tab-pump">Pump Status</div>
      <div class="tab" data-screen="temp" id="tab-temp">Temperature Monitor</div>
    </div>

    <div class="content">
      <section class="card" id="screen-pump">
        <div class="card-header">
          <div>
            <div class="card-title">Pump status</div>
            <div class="card-subtitle">Centrifugal circulation pump</div>
          </div>
        </div>

        <div class="pump-layout">
          <div class="pump-visual">
            <div class="pump-ring" id="pump-ring">
              <div class="pump-core">
                <div class="pump-blade"></div>
              </div>
            </div>
            <div class="pump-state-label">Current status</div>
            <div id="pump-state-pill" class="pill-large pill-unknown">
              <span id="pump-state-text">UNKNOWN</span>
            </div>
            <div class="pump-meta">
              Last confirmed state: <span id="pump-last-confirmed">–</span>
            </div>
          </div>

          <div class="pump-controls">
            <div class="status-line" id="pump-status-line">
              <div class="status-dot-small status-dot-pending" id="pump-status-dot"></div>
              <span id="pump-status-message">Waiting for server status…</span>
            </div>

            <button class="primary-btn disabled" id="pump-toggle-btn">
              <span id="pump-btn-label">Activate pump</span>
            </button>

            <div class="error-banner" id="pump-error" style="display:none;">
              Command failed. Pump did not reach the requested state; status unchanged.
            </div>
          </div>
        </div>
      </section>

      <section class="card" id="screen-temp" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">Water temperature</div>
            <div class="card-subtitle">Inlet vs outlet (live + history)</div>
          </div>
        </div>

        <div class="temp-grid">
          <div class="temp-card">
            <div class="temp-label">Water In</div>
            <div class="temp-value-row">
              <div>
                <span class="temp-value" id="temp-in-value">–</span>
                <span class="temp-unit">°C</span>
              </div>
              <div class="trend" id="temp-in-trend">–</div>
            </div>
          </div>
          <div class="temp-card">
            <div class="temp-label">Water Out</div>
            <div class="temp-value-row">
              <div>
                <span class="temp-value" id="temp-out-value">–</span>
                <span class="temp-unit">°C</span>
              </div>
              <div class="trend" id="temp-out-trend">–</div>
            </div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item" data-series="in">
            <div class="legend-color" style="background:#38bdf8;"></div>
            <span>Water In</span>
          </div>
          <div class="legend-item" data-series="out">
            <div class="legend-color" style="background:#f97316;"></div>
            <span>Water Out</span>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-meta">
            <div>Last update: <span id="chart-last-update">–</span></div>
            <div class="range-selector">
              <button class="range-btn active" data-range="1h">1 h</button>
              <button class="range-btn" data-range="6h">6 h</button>
              <button class="range-btn" data-range="24h">24 h</button>
              <button class="range-btn" data-range="7d">7 d</button>
              <button class="range-btn" data-range="30d">30 d</button>
            </div>
          </div>
          <div class="chart-overlay">
            <canvas id="temp-chart"></canvas>
            <div class="chart-overlay-message" id="chart-overlay-msg">
              Live updates paused – reconnecting to server…
            </div>
          </div>
        </div>

        <div class="card-subtitle" style="margin-top:10px;">
          Data refresh: every 5 seconds from server. Range is served from backend history (hopefully when i get to it).
        </div>
      </section>
    </div>
  </div>

  <script>
    const connection = { connected: false };
    const pump = { state: "UNKNOWN", pending: false, lastConfirmed: null };
    const temps = {
      dataIn: [],
      dataOut: [],
      maxPoints: 300,
      showIn: true,
      showOut: true,
      range: "1h"
    };

    const $ = (id) => document.getElementById(id);
    const pumpRingEl = $("pump-ring");
    const pumpStatePill = $("pump-state-pill");
    const pumpStateText = $("pump-state-text");
    const pumpLastConfirmed = $("pump-last-confirmed");
    const pumpStatusDot = $("pump-status-dot");
    const pumpStatusMessage = $("pump-status-message");
    const pumpToggleBtn = $("pump-toggle-btn");
    const pumpBtnLabel = $("pump-btn-label");
    const pumpError = $("pump-error");
    const connectionDot = $("connection-dot");
    const connectionText = $("connection-text");
    const connectionPill = $("connection-pill");
    const screenPump = $("screen-pump");
    const screenTemp = $("screen-temp");
    const tabPump = $("tab-pump");
    const tabTemp = $("tab-temp");
    const tempInValue = $("temp-in-value");
    const tempOutValue = $("temp-out-value");
    const tempInTrend = $("temp-in-trend");
    const tempOutTrend = $("temp-out-trend");
    const chartLastUpdate = $("chart-last-update");
    const chartOverlayMsg = $("chart-overlay-msg");
    const rangeButtons = document.querySelectorAll(".range-btn");
    const legendItems = document.querySelectorAll(".legend-item");
    const canvas = $("temp-chart");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resizeCanvas();
    window.addEventListener("resize", () => {
      resizeCanvas();
      drawChart();
    });

    function formatTime(date) {
      if (!date) return "–";
      return new Date(date).toLocaleTimeString();
    }

    function setConnection(connected) {
      connection.connected = connected;
      if (connected) {
        connectionDot.classList.remove("disconnected");
        connectionDot.classList.add("connected");
        connectionText.textContent = "Connected to server";
        connectionPill.style.borderColor = "rgba(34, 197, 94, 0.55)";
        chartOverlayMsg.classList.remove("visible");
      } else {
        connectionDot.classList.remove("connected");
        connectionDot.classList.add("disconnected");
        connectionText.textContent = "Disconnected from server";
        connectionPill.style.borderColor = "rgba(239, 68, 68, 0.55)";
        chartOverlayMsg.classList.add("visible");
      }
      updatePumpUI();
    }

    function updatePumpUI() {
      let borderColor = "var(--accent-off)";
      if (pump.state === "ON") borderColor = "var(--accent-on)";
      else if (pump.state === "UNKNOWN") borderColor = "var(--accent-unknown)";
      pumpRingEl.style.borderColor = borderColor;

      pumpStatePill.classList.remove("pill-on", "pill-off", "pill-unknown");
      if (pump.state === "ON") pumpStatePill.classList.add("pill-on");
      else if (pump.state === "OFF") pumpStatePill.classList.add("pill-off");
      else pumpStatePill.classList.add("pill-unknown");
      pumpStateText.textContent = pump.state;
      pumpLastConfirmed.textContent = formatTime(pump.lastConfirmed);

      pumpError.style.display = "none";

      if (!connection.connected) {
        pumpStatusDot.className = "status-dot-small status-dot-error";
        pumpStatusMessage.textContent = "Server offline. Status may be outdated.";
        pumpToggleBtn.classList.add("disabled");
        pumpToggleBtn.disabled = true;
        pumpBtnLabel.textContent = pump.state === "ON" ? "Deactivate pump" : "Activate pump";
        pumpToggleBtn.querySelector(".btn-spinner")?.remove();
        return;
      }

      if (pump.pending) {
        pumpStatusDot.className = "status-dot-small status-dot-pending";
        pumpStatusMessage.textContent = "Awaiting server confirmation…";
        pumpToggleBtn.classList.add("disabled");
        pumpToggleBtn.disabled = true;
        if (!pumpToggleBtn.querySelector(".btn-spinner")) {
          const spinner = document.createElement("div");
          spinner.className = "btn-spinner";
          pumpToggleBtn.insertBefore(spinner, pumpBtnLabel);
        }
      } else {
        pumpStatusDot.className = "status-dot-small";
        pumpStatusMessage.textContent = "Confirmed by server.";
        pumpToggleBtn.classList.remove("disabled");
        pumpToggleBtn.disabled = false;
        pumpToggleBtn.querySelector(".btn-spinner")?.remove();
      }

      const targetLabel = pump.state === "ON" ? "Deactivate pump" : "Activate pump";
      pumpBtnLabel.textContent = targetLabel;
    }

    function showPumpError() {
      pumpError.style.display = "block";
      pumpStatusDot.className = "status-dot-small status-dot-error";
      pumpStatusMessage.textContent = "Command failed; pump state unchanged.";
      pump.pending = false;
      pumpToggleBtn.querySelector(".btn-spinner")?.remove();
      pumpToggleBtn.classList.remove("disabled");
      pumpToggleBtn.disabled = false;
    }

    function updateTempCards() {
      const lastIn = temps.dataIn[temps.dataIn.length - 1];
      const lastOut = temps.dataOut[temps.dataOut.length - 1];

      if (lastIn) {
        tempInValue.textContent = lastIn.value.toFixed(1);
        const prev = temps.dataIn[temps.dataIn.length - 2];
        let trendLabel = "Stable";
        let trendClass = "";
        if (prev) {
          const diff = lastIn.value - prev.value;
          if (diff > 0.05) { trendLabel = "Rising"; trendClass = "trend-up"; }
          else if (diff < -0.05) { trendLabel = "Falling"; trendClass = "trend-down"; }
        }
        tempInTrend.textContent = trendLabel;
        tempInTrend.className = "trend " + trendClass;
      }

      if (lastOut) {
        tempOutValue.textContent = lastOut.value.toFixed(1);
        const prev = temps.dataOut[temps.dataOut.length - 2];
        let trendLabel = "Stable";
        let trendClass = "";
        if (prev) {
          const diff = lastOut.value - prev.value;
          if (diff > 0.05) { trendLabel = "Rising"; trendClass = "trend-up"; }
          else if (diff < -0.05) { trendLabel = "Falling"; trendClass = "trend-down"; }
        }
        tempOutTrend.textContent = trendLabel;
        tempOutTrend.className = "trend " + trendClass;
      }

      const latestTime = lastOut?.time || lastIn?.time;
      chartLastUpdate.textContent = latestTime ? formatTime(latestTime) : "–";
    }

    function drawChart() {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
      const padding = { top: 18, right: 10, bottom: 20, left: 40 };
      const width = rect.width - padding.left - padding.right;
      const height = rect.height - padding.top - padding.bottom;
      if (width <= 0 || height <= 0) return;

      const dataIn = temps.dataIn;
      const dataOut = temps.dataOut;
      if (!dataIn.length && !dataOut.length) {
        ctx.fillStyle = "rgba(148, 163, 184, 0.45)";
        ctx.font = "12px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Waiting for temperature samples…", rect.width / 2, rect.height / 2);
        return;
      }

      const minY = 10;
      const maxY = 30;
      const allPoints = [...dataIn, ...dataOut];
      const minX = allPoints[0].time.getTime();
      const maxX = allPoints[allPoints.length - 1].time.getTime() || minX + 1;

      function xScale(t) {
        return padding.left + ((t - minX) / (maxX - minX || 1)) * width;
      }

      function yScale(v) {
        return padding.top + ((maxY - v) / (maxY - minY || 1)) * height;
      }

      ctx.save();
      ctx.translate(0.5, 0.5);

      ctx.strokeStyle = "rgba(148, 163, 184, 0.25)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding.left, padding.top);
      ctx.lineTo(padding.left, padding.top + height);
      ctx.lineTo(padding.left + width, padding.top + height);
      ctx.stroke();

      ctx.fillStyle = "rgba(148, 163, 184, 0.8)";
      ctx.font = "10px system-ui";
      ctx.textAlign = "right";
      const step = 5;
      for (let v = minY; v <= maxY; v += step) {
        const y = yScale(v);
        ctx.strokeStyle = "rgba(30, 64, 175, 0.35)";
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(padding.left + width, y);
        ctx.stroke();
        ctx.fillText(v.toString(), padding.left - 6, y + 3);
      }

      function drawSeries(data, color) {
        if (data.length < 2) return;
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          const p = data[i];
          const x = xScale(p.time.getTime());
          const y = yScale(p.value);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      if (temps.showIn) drawSeries(dataIn, "#38bdf8");
      if (temps.showOut) drawSeries(dataOut, "#f97316");

      ctx.restore();
    }

    [tabPump, tabTemp].forEach((tab) => {
      tab.addEventListener("click", () => {
        if (tab.dataset.screen === "pump") {
          tabPump.classList.add("active");
          tabTemp.classList.remove("active");
          screenPump.style.display = "block";
          screenTemp.style.display = "none";
        } else {
          tabTemp.classList.add("active");
          tabPump.classList.remove("active");
          screenTemp.style.display = "block";
          screenPump.style.display = "none";
        }
      });
    });

    const SERVER_HOST = window.location.hostname || "localhost";
    const SERVER_PORT = 3000;
    const WS_URL = `ws://${SERVER_HOST}:${SERVER_PORT}`;
    const API_BASE = `http://${SERVER_HOST}:${SERVER_PORT}`;
    let ws;

    function connectWebSocket() {
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        setConnection(true);
      };

      ws.onclose = () => {
        setConnection(false);
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        setConnection(false);
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "snapshot") {
          if (msg.pump) {
            pump.state = msg.pump.state || "UNKNOWN";
            pump.lastConfirmed = msg.pump.lastConfirmed ? new Date(msg.pump.lastConfirmed) : null;
            pump.pending = false;
            updatePumpUI();
          }
          if (msg.temps) {
            const t = new Date(msg.temps.updatedAt);
            temps.dataIn.push({ time: t, value: msg.temps.in });
            temps.dataOut.push({ time: t, value: msg.temps.out });
            updateTempCards();
            drawChart();
          }
        } else if (msg.type === "pump_status") {
          pump.state = msg.state || "UNKNOWN";
          pump.lastConfirmed = msg.lastConfirmed ? new Date(msg.lastConfirmed) : new Date();
          pump.pending = false;
          updatePumpUI();
        } else if (msg.type === "temp_sample") {
          const t = new Date(msg.updatedAt);
          temps.dataIn.push({ time: t, value: msg.in });
          temps.dataOut.push({ time: t, value: msg.out });
          if (temps.dataIn.length > temps.maxPoints) temps.dataIn.shift();
          if (temps.dataOut.length > temps.maxPoints) temps.dataOut.shift();
          updateTempCards();
          drawChart();
        } else if (msg.type === "pump_command_result" && msg.ok === false) {
          showPumpError();
        }
      };
    }
    connectWebSocket();

    pumpToggleBtn.addEventListener("click", async () => {
      if (pump.pending || !connection.connected) return;
      const target = pump.state === "ON" ? "OFF" : "ON";
      pump.pending = true;
      updatePumpUI();

      try {
        const res = await fetch(`${API_BASE}/api/pump/command`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target }),
        });
        if (!res.ok) {
          showPumpError();
          return;
        }
      } catch (err) {
        showPumpError();
      }
    });

    rangeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        rangeButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        temps.range = btn.dataset.range;
        drawChart();
      });
    });

    legendItems.forEach((item) => {
      item.addEventListener("click", () => {
        const series = item.dataset.series;
        if (series === "in") {
          temps.showIn = !temps.showIn;
          item.style.opacity = temps.showIn ? "1" : "0.4";
        } else {
          temps.showOut = !temps.showOut;
          item.style.opacity = temps.showOut ? "1" : "0.4";
        }
        drawChart();
      });
    });
  </script>
</body>
</html>
